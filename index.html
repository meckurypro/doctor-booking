<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkAI Doctor Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #0f172a;
            line-height: 1.5;
            color: #e2e8f0;
        }
        
        .container {
            max-width: 24rem;
            margin: 0 auto;
            padding: 3rem 1rem;
            width: 100%;
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 300;
            color: #f1f5f9;
            margin: 0 0 0.5rem 0;
        }
        
        .header p {
            color: #94a3b8;
            font-size: 0.875rem;
            margin: 0;
        }
        
        .form-container {
            background: #1e293b;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            border: 1px solid #334155;
            padding: 2rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group:last-of-type {
            margin-bottom: 0;
        }
        
        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #f1f5f9;
            margin-bottom: 0.5rem;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #475569;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            font-family: inherit;
            background-color: #334155;
            color: #e2e8f0;
        }
        
        input::placeholder, textarea::placeholder {
            color: #94a3b8;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        textarea {
            resize: none;
            min-height: 4rem;
        }
        
        .submit-btn {
            width: 100%;
            background-color: #3b82f6;
            color: white;
            font-weight: 500;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 1.5rem;
        }
        
        .submit-btn:hover {
            background-color: #2563eb;
        }
        
        .submit-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        
        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .loading-state {
            display: none;
            text-align: center;
            padding: 1rem 0;
        }
        
        .loading-state.active {
            display: block;
        }
        
        .spinner {
            display: inline-block;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #3b82f6;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .loading-text {
            font-size: 0.875rem;
            color: #94a3b8;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background-color: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.75rem;
            padding: 2rem;
            max-width: 24rem;
            width: 100%;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .modal-icon.success {
            background-color: #064e3b;
            color: #a7f3d0;
        }
        
        .modal-icon.error {
            background-color: #7f1d1d;
            color: #fca5a5;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #f1f5f9;
            margin: 0 0 1rem 0;
        }
        
        .modal-message {
            color: #94a3b8;
            margin: 0 0 1.5rem 0;
            line-height: 1.6;
        }
        
        .modal-close-btn {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .modal-close-btn:hover {
            background-color: #2563eb;
        }
        
        .modal-close-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        
        .hidden {
            display: none !important;
        }

        .debug-info {
            background: #374151;
            border: 1px solid #4b5563;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.75rem;
            color: #d1d5db;
        }

        .debug-info pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .fallback-notice {
            background: #7c2d12;
            border: 1px solid #ea580c;
            color: #fed7aa;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            text-align: center;
        }
        
        @media (max-width: 640px) {
            .container {
                padding: 1.5rem 1rem;
            }
            
            .form-container {
                padding: 1.5rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>LinkAI Doctor Booking</h1>
            <p>Schedule your appointment with our medical professionals</p>
        </div>

        <!-- Main Form Container -->
        <div class="form-container">
            <!-- Fallback Notice (only shown if using fallback method) -->
            <div id="fallbackNotice" class="fallback-notice hidden">
                <strong>Notice:</strong> Direct booking is currently experiencing technical issues. Your booking will be processed via email instead.
            </div>

            <form id="bookingForm">
                <!-- Patient Name -->
                <div class="form-group">
                    <label for="patientName">Patient Name</label>
                    <input 
                        type="text" 
                        id="patientName" 
                        name="patientName" 
                        required 
                        placeholder="Enter patient's full name"
                    >
                </div>

                <!-- Email -->
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        required 
                        placeholder="Enter email address"
                    >
                </div>

                <!-- Phone Number -->
                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input 
                        type="tel" 
                        id="phone" 
                        name="phone" 
                        required 
                        placeholder="Enter phone number"
                    >
                </div>

                <!-- Doctor Selection -->
                <div class="form-group">
                    <label for="doctor">Select Doctor</label>
                    <select 
                        id="doctor" 
                        name="doctor" 
                        required
                    >
                        <option value="" disabled selected>Choose a doctor</option>
                        <option value="Dr. Adebayo Ogundimu">Dr. Adebayo Ogundimu</option>
                        <option value="Dr. Chioma Goodness">Dr. Chioma Goodness</option>
                        <option value="Dr. Ibrahim Musa">Dr. Ibrahim Musa</option>
                        <option value="Dr. Folake Adeniyi">Dr. Folake Adeniyi</option>
                        <option value="Dr. Emeka Madu">Dr. Emeka Madu</option>
                        <option value="Dr. Aisha Abdullahi">Dr. Aisha Abdullahi</option>
                        <option value="Dr. Olumide Babatunde">Dr. Olumide Babatunde</option>
                        <option value="Dr. Blessing Okoro">Dr. Blessing Okoro</option>
                    </select>
                </div>

                <!-- Date and Time Row -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="date">Date</label>
                        <input 
                            type="date" 
                            id="date" 
                            name="date" 
                            required
                        >
                    </div>
                    <div class="form-group">
                        <label for="time">Time</label>
                        <input 
                            type="time" 
                            id="time" 
                            name="time" 
                            required
                        >
                    </div>
                </div>

                <!-- Appointment Type -->
                <div class="form-group">
                    <label for="appointmentType">Appointment Type</label>
                    <select 
                        id="appointmentType" 
                        name="appointmentType" 
                        required
                    >
                        <option value="" disabled selected>Select appointment type</option>
                        <option value="Consultation">General Consultation</option>
                        <option value="Follow-up">Follow-up Visit</option>
                        <option value="Check-up">Routine Check-up</option>
                        <option value="Emergency">Emergency Consultation</option>
                    </select>
                </div>

                <!-- Notes -->
                <div class="form-group">
                    <label for="notes">Additional Notes (Optional)</label>
                    <textarea 
                        id="notes" 
                        name="notes"
                        placeholder="Any specific concerns or information the doctor should know..."
                    ></textarea>
                </div>

                <!-- Submit Button -->
                <button 
                    type="submit" 
                    class="submit-btn"
                    id="submitBtn"
                >
                    Book Appointment
                </button>
            </form>

            <!-- Loading State -->
            <div id="loadingState" class="loading-state">
                <div class="spinner"></div>
                <span class="loading-text">Booking your appointment...</span>
            </div>

            <!-- Debug Information -->
            <div id="debugInfo" class="debug-info" style="display: none;">
                <strong>Debug Info:</strong>
                <pre id="debugContent"></pre>
            </div>
        </div>

        <!-- Modal Overlay -->
        <div id="modalOverlay" class="modal-overlay">
            <div class="modal-content">
                <div id="modalIcon" class="modal-icon"></div>
                <h3 id="modalTitle" class="modal-title"></h3>
                <p id="modalMessage" class="modal-message"></p>
                <button id="modalCloseBtn" class="modal-close-btn">Close</button>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('bookingForm');
        const submitBtn = document.getElementById('submitBtn');
        const loadingState = document.getElementById('loadingState');
        const modalOverlay = document.getElementById('modalOverlay');
        const modalIcon = document.getElementById('modalIcon');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const debugInfo = document.getElementById('debugInfo');
        const debugContent = document.getElementById('debugContent');
        const fallbackNotice = document.getElementById('fallbackNotice');

        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').min = today;

        // Configuration
        const config = {
            zapierUrl: 'https://hooks.zapier.com/hooks/catch/24388341/uhd4dis/',
            proxyUrl: '/api/book-appointment', // Your Node.js proxy endpoint
            fallbackEmail: 'dankemeckury@gmail.com'
        };

        function showDebugInfo(info) {
            debugContent.textContent = JSON.stringify(info, null, 2);
            debugInfo.style.display = 'block';
        }

        function showModal(title, message, type) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            // Set icon and styling based on type
            modalIcon.className = `modal-icon ${type}`;
            modalIcon.innerHTML = type === 'success' ? '✓' : '✕';
            
            modalOverlay.classList.add('active');
        }

        function hideModal() {
            modalOverlay.classList.remove('active');
        }

        // Close modal when clicking the close button
        modalCloseBtn.addEventListener('click', hideModal);

        // Close modal when clicking outside of it
        modalOverlay.addEventListener('click', function(event) {
            if (event.target === modalOverlay) {
                hideModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && modalOverlay.classList.contains('active')) {
                hideModal();
            }
        });

        // Try to send via proxy server first, then fallback to email
        async function sendBookingRequest(data, method = 'proxy') {
            if (method === 'proxy') {
                // Try proxy server first
                return await fetch(config.proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
            } else if (method === 'direct') {
                // Try direct to Zapier (might fail due to CORS)
                return await fetch(config.zapierUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'no-cors', // This might help bypass CORS but limits response access
                    body: JSON.stringify(data)
                });
            } else if (method === 'form') {
                // Try form submission approach
                const formData = new URLSearchParams();
                Object.keys(data).forEach(key => {
                    formData.append(key, data[key]);
                });

                return await fetch(config.zapierUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData
                });
            }
        }

        // Fallback: Create a mailto link
        function createEmailFallback(data) {
            const subject = encodeURIComponent('New Doctor Appointment Booking');
            const body = encodeURIComponent(`
New appointment booking request:

Patient Name: ${data.patientName}
Email: ${data.email}
Phone: ${data.phone}
Doctor: ${data.doctor}
Date: ${data.date}
Time: ${data.time}
Appointment Type: ${data.appointmentType}
Additional Notes: ${data.notes || 'None'}

Please confirm this appointment and send confirmation details to the patient.

Submitted on: ${new Date().toLocaleString()}
            `.trim());

            const mailtoLink = `mailto:${config.fallbackEmail}?subject=${subject}&body=${body}`;
            
            // Show fallback notice
            fallbackNotice.classList.remove('hidden');
            
            // Open email client
            window.location.href = mailtoLink;
            
            return true;
        }

        form.addEventListener('submit', async function(event) {
            event.preventDefault();

            // Show loading state
            form.classList.add('hidden');
            loadingState.classList.add('active');
            
            // Prepare form data
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Add timestamp
            data.timestamp = new Date().toISOString();
            data.submissionId = Date.now().toString();

            showDebugInfo({
                attemptingMethod: 'proxy',
                data: data,
                timestamp: new Date().toISOString()
            });

            let success = false;
            let lastError = null;

            // Try multiple methods in order of preference
            const methods = ['proxy', 'direct', 'form'];
            
            for (let method of methods) {
                try {
                    console.log(`Trying method: ${method}`);
                    
                    const response = await sendBookingRequest(data, method);
                    
                    if (method === 'direct' && response.type === 'opaque') {
                        // no-cors mode: we can't read the response, but assume it worked
                        console.log('Direct method completed (no-cors)');
                        success = true;
                        break;
                    }
                    
                    if (response.ok) {
                        console.log(`Method ${method} succeeded`);
                        
                        let result;
                        try {
                            result = await response.json();
                        } catch (e) {
                            result = await response.text();
                        }
                        
                        console.log('Response:', result);
                        
                        // Handle different response formats
                        if (typeof result === 'object' && result.status === 'conflict') {
                            showModal(
                                'Appointment Unavailable',
                                `Sorry, ${data.doctor} already has an appointment scheduled for ${data.date} at ${data.time}. Please choose a different time slot.`,
                                'error'
                            );
                        } else {
                            showModal(
                                'Booking Confirmed!',
                                `Your appointment with ${data.doctor} has been successfully booked for ${data.date} at ${data.time}. You will receive a confirmation email shortly.`,
                                'success'
                            );
                            form.reset();
                        }
                        
                        success = true;
                        break;
                        
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                } catch (error) {
                    console.error(`Method ${method} failed:`, error);
                    lastError = error;
                    
                    // Update debug info
                    showDebugInfo({
                        failedMethod: method,
                        error: error.message,
                        data: data,
                        timestamp: new Date().toISOString()
                    });
                    
                    continue; // Try next method
                }
            }

            // If all methods failed, use email fallback
            if (!success) {
                console.log('All methods failed, using email fallback');
                
                try {
                    createEmailFallback(data);
                    
                    showModal(
                        'Booking Request Sent',
                        'Your booking request has been sent via email. Our team will contact you shortly to confirm your appointment. Please check that your email client opened with the booking details.',
                        'success'
                    );
                    
                    form.reset();
                    
                } catch (emailError) {
                    showModal(
                        'Booking Error',
                        `Unable to process your booking request. Please contact us directly at ${config.fallbackEmail} with your appointment details. Error: ${lastError?.message || 'Unknown error'}`,
                        'error'
                    );
                    
                    showDebugInfo({
                        allMethodsFailed: true,
                        lastError: lastError?.message,
                        emailFallbackError: emailError.message,
                        data: data,
                        timestamp: new Date().toISOString()
                    });
                }
            }

            // Hide loading state and show form
            loadingState.classList.remove('active');
            form.classList.remove('hidden');
        });
    </script>
</body>
</html>
